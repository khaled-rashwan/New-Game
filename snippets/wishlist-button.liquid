{% comment %}
  Add to Wishlist Button
  Usage: {% render 'wishlist-button', product: product %}
{% endcomment %}

<style>
  .wishlist-button-wrapper {
    display: inline-block;
    margin-top: 16px;
  }

  .wishlist-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 24px;
    background: transparent;
    border: 2px solid #e5e5e5;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
    font-weight: 600;
    color: #1a1a1a;
    width: 100%;
  }

  .wishlist-button:hover {
    border-color: #d32f2f;
    background: #ffebee;
  }

  .wishlist-button.active {
    background: #d32f2f;
    border-color: #d32f2f;
    color: #ffffff;
  }

  .wishlist-button svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
    transition: fill 0.3s;
  }

  .wishlist-button.active svg {
    fill: currentColor;
  }

  @media (max-width: 768px) {
    .wishlist-button {
      padding: 12px 20px;
      font-size: 13px;
    }
  }
</style>

<div class="wishlist-button-wrapper">
  <button class="wishlist-button" 
          data-product-id="{{ product.id }}"
          data-product-title="{{ product.title | escape }}"
          data-product-url="{{ product.url }}"
          data-product-image="{{ product.featured_image | image_url: width: 400 }}"
          data-product-price="{{ product.price }}"
          data-product-type="{{ product.product_type | escape }}"
          onclick="toggleWishlist(this)">
    <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
    </svg>
    <span class="wishlist-button-text">Add to Wishlist</span>
  </button>
</div>

<script>
(function() {
  const storageKey = 'newgame_wishlist';
  
  function isInWishlist(productId) {
    const wishlist = JSON.parse(localStorage.getItem(storageKey) || '[]');
    return wishlist.some(item => item.id === productId);
  }
  
  function addToWishlist(productData) {
    let wishlist = JSON.parse(localStorage.getItem(storageKey) || '[]');
    if (!wishlist.some(item => item.id === productData.id)) {
      wishlist.push(productData);
      localStorage.setItem(storageKey, JSON.stringify(wishlist));
      return true;
    }
    return false;
  }
  
  function removeFromWishlist(productId) {
    let wishlist = JSON.parse(localStorage.getItem(storageKey) || '[]');
    wishlist = wishlist.filter(item => item.id !== productId);
    localStorage.setItem(storageKey, JSON.stringify(wishlist));
    return true;
  }
  
  window.toggleWishlist = function(button) {
    const productId = parseInt(button.dataset.productId);
    const isAdded = isInWishlist(productId);
    
    if (isAdded) {
      removeFromWishlist(productId);
      button.classList.remove('active');
      button.querySelector('.wishlist-button-text').textContent = 'Add to Wishlist';
    } else {
      const productData = {
        id: productId,
        title: button.dataset.productTitle,
        url: button.dataset.productUrl,
        image: button.dataset.productImage,
        price: parseInt(button.dataset.productPrice),
        type: button.dataset.productType
      };
      addToWishlist(productData);
      button.classList.add('active');
      button.querySelector('.wishlist-button-text').textContent = 'In Wishlist';
    }
    
    if (typeof updateWishlistCount === 'function') {
      updateWishlistCount();
    }
  };
  
  function updateWishlistCount() {
    const wishlist = JSON.parse(localStorage.getItem(storageKey) || '[]');
    const countBadge = document.querySelector('.wishlist-count');
    if (countBadge) {
      countBadge.textContent = wishlist.length;
      countBadge.style.display = wishlist.length > 0 ? 'flex' : 'none';
    }
  }
  
  function initWishlistButtons() {
    document.querySelectorAll('.wishlist-button').forEach(button => {
      const productId = parseInt(button.dataset.productId);
      if (isInWishlist(productId)) {
        button.classList.add('active');
        button.querySelector('.wishlist-button-text').textContent = 'In Wishlist';
      }
    });
    updateWishlistCount();
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWishlistButtons);
  } else {
    initWishlistButtons();
  }
})();
</script>
